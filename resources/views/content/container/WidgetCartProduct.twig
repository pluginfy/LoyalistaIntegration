<style>
    .label {
        background-color: #fff;
        text-align: left;
        color: #000;
        display: inline-block;
        cursor: pointer;
    }
    div.widget-widget_wrapper_loyalista{
        margin-top: 15px;
        margin-bottom: 15px;
        border: 1px solid #666;
        padding: 5px;
    }
</style>

<div class="widget_wrapper_loyalista" style="">
    <h2>Bonusprogramm</h2>
    <div class = "widget-widget_wrapper_loyalista">
        <label class="label">
            <div class="pluginfy_cart_contents_wrapper">
                <input id="yes_rgisistered_loyalista_programme" type="checkbox" value="text">
                {{ contents | raw }}
            </div>
        </label>
        <button class="btn btn-primary btn-appearance"
                onclick="register_me(this)"> {{ btn_label }}</button>
    </div>

</div>

<script>
    function setPointBait(){

        let target_span = $('div.pluginfy_cart_contents_wrapper').find('span.loyalista_num_of_points');

        $.ajax({
            url: '/user/total/basket/',
            type: "GET",
            data: {},
            dataType: "json",
            cache: true
        }).done(function (return_data) {
            try {

                var data;
                if (typeof return_data === 'object') data = return_data;
                else data = $.parseJSON(return_data);

                if (data.status === "OK") {

                    let basket_total = data.basket_total;
                    let conversion = $('span.loyalista_num_of_points').data('revenue_to_point');

                    let points = Math.floor(basket_total /  conversion);
                    target_span.html(points);

                    // Get and Set current cart total
                    // str_plugin_cart_total = $('dd[data-testing="basket-amount"]').text();


                } else {
                    $(_obj).attr('disabled' , false);
                    alert(data.message);
                }
            } catch (error) {
                console.log(error);
                $(_obj).attr('disabled' , false);
            }
        }).fail(function (data) {
            $(_obj).attr('disabled' , false);
        });
    }
    function register_me(_obj) {
        $(_obj).attr('disabled' , true);

        let checked = $('#yes_rgisistered_loyalista_programme').is(":checked");

        if(!checked){
            $(_obj).attr('disabled' , false);
            return false;
        }

        $.ajax({
            url: '/account/register/customer/',
            type: "GET",
            data: {},
            dataType: "json",
            cache: true
        }).done(function (return_data) {
            try {
                var data;
                if (typeof return_data === 'object') data = return_data;
                else data = $.parseJSON(return_data);
                if (data.status === "OK") {
                    location.reload();
                } else {
                    $(_obj).attr('disabled' , false);
                    alert(data.message);
                }
            } catch (error) {
                console.log(error);
                $(_obj).attr('disabled' , false);
            }
        }).fail(function (data) {
            $(_obj).attr('disabled' , false);
        });
    }
    $(function(){

        $('.totalSum dd[data-testing="basket-amount"]').bind('DOMSubtreeModified', function(){
           setPointBait();
        });

    });
</script>

